# #+BEGIN_SRC sql :engine postgresql :dbpassword test1 :database dbgeo1 :results drawer :exports code
# #+BEGIN_SRC sql :engine postgresql :dbpassword test1 :dbuser user :database dbgeo1 :exports code :results silent

* Query to get test parcels

#+BEGIN_SRC sql -n :engine postgresql :exports code :cmdline "-A -t -w -h localhost -d dbgeo1 -U user" :cache no
SELECT
name, way
FROM planet_osm_polygon
WHERE tags->'leisure'='park'
AND name LIKE '%Herăstrău%'
ORDER BY ST_Area(way) DESC
LIMIT 1;
#+END_SRC

#+RESULTS:
| Parcul Herăstrău | 010300002031BF0D0001000000A40000005C8FC2F5CC254641EC51B8CE302255419A9999B9CE254641B81E852B3D2255410AD7A370D4254641666666464522554152B81EE5DB254641AE47E1BA46225541F6285C6FF2254641666666164A225541713D0AF7192646413D0AD7434F225541E17A148E1F264641713D0A474D2255410AD7A3F02C264641EC51B84E4E225541295C8F2237264641295C8F124F225541F6285C0F4F264641E17A148E532255413333335367264641F6285C5F582255415C8FC2D582264641EC51B86E5F2255413D0AD7239E26464152B81EE567225541D7A370BDAA264641D7A3707D6C225541A4703DCABB26464148E17A7475225541713D0A57CC264641C3F5281C802255413D0AD723E4264641F6285CCF8D225541D7A370DDE4264641333333D3902255417B14AEE7E826464185EB515894225541F6285CAFEB26464185EB516898225541000000E0F3264641AE47E14A98225541C3F528BCF526464133333313992255418FC2F5E8F3264641295C8F229B225541A4703D6AF3264641B81E851B9D2255411F85EB1100274641000000F0A7225541000000E005274641CDCCCCECA822554185EB515806274641D7A3702DAC225541C3F528BC0B2746410AD7A310B0225541A4703D2A132746415C8FC2C5B6225541C3F5287C1C274641713D0AA7BA225541F6285C4F232746411F85EB81BD22554185EB5178272746410AD7A3B0C1225541E17A142E2E274641C3F5281CC922554185EB515840274641713D0A27DE225541666666A6432746415C8FC2C5E5225541F6285C0F48274641F6285C7FE8225541E17A14EE4B2746411F85EB71F322554152B81E454E274641B81E852BF4225541D7A370DD4D274641F6285C0FF8225541F6285CEF4C274641F6285CCFFF225541000000604C27464185EB51B80B235541333333734D2746415C8FC29514235541295C8FC24627464166666676182355413D0AD743422746411F85EBE11F235541EC51B8BE3B2746418FC2F568232355413D0AD72341274641E17A14CE27235541CDCCCC2C3F2746417B14AE272F235541AE47E15A39274641F6285C5F33235541B81E85EB2427464152B81E8539235541000000A01E27464148E17A243C2355416666664618274641A4703D7A3E235541E17A14CE0F274641C3F5285C41235541EC51B85E0D274641C3F5287C44235541AE47E1DA04274641EC51B83E48235541D7A3703D02274641CDCCCC7C48235541713D0A57FD264641333333F34923554148E17A74F7264641A4703D4A522355418FC2F5A8F5264641EC51B81E55235541E17A146EF32646415C8FC2D559235541713D0A57F4264641E17A149E5E235541E17A146EF2264641A4703DDA662355417B14AE87EB2646417B14AEE76E23554185EB5158E2264641666666367E235541EC51B87ED8264641713D0A4788235541295C8F42D02646417B14AEB78F2355418FC2F588C4264641CDCCCCAC97235541A4703D8AB72646418FC2F5889F2355411F85EBB1A3264641C3F5288CA5235541EC51B8DE9126464152B81E35A9235541333333337E264641333333C3AB235541A4703DCA6726464166666676AE23554185EB5178512646417B14AEB7B0235541AE47E1DA39264641713D0A57B1235541CDCCCCEC30264641000000A0AF235541D7A370DD292646410AD7A3C0AD235541C3F5289C272646419A999929B023554114AE4701382646410AD7A3F0B62355418FC2F5E8552646415C8FC2D5B52355418FC2F56871264641295C8FD2B2235541D7A3703D8E264641F6285C0FAF2355410AD7A350A6264641AE47E14AAA235541295C8FA2C22646418FC2F558A32355415C8FC275D9264641F6285CFF9C2355415C8FC255EC264641CDCCCCFC97235541D7A3701DFB2646413D0AD73394235541C3F5287C3F27464152B81E157F235541F6285CAF4D27464148E17A547923554185EB51385A274641B81E85AB72235541E17A142E7B2746411F85EB915C235541AE47E17A8E27464148E17AC455235541C3F5281C952746415C8FC2C54823554185EB51F896274641295C8FF23B235541F6285C2F9F27464166666626DE2255418FC2F548A1274641000000B0C32255415C8FC2F5A22746417B14AE27AB225541713D0AB7A4274641666666F6922255410AD7A3D0A5274641295C8F6282225541666666E6A82746417B14AED764225541A4703DEAAE274641333333034E22554100000040B62746417B14AE873E2255415C8FC215C0274641713D0A9730225541AE47E13ACB274641666666D6222255417B14AE07DC27464166666646152255410AD7A3F0FD274641666666E6F821554185EB51D81F2846418FC2F548DD215541295C8F22272846417B14AE97D5215541333333334828464100000020B72155411F85EB71562846418FC2F598AB2155419A9999596C284641000000809C21554166666686B3284641666666C67621554114AE4781B728464148E17A146E215541D7A3701DB728464114AE4751652155419A9999B9B4284641E17A14EE5D215541AE47E15AAD2846415C8FC295572155411F85EBF1BB2846415C8FC2154D215541D7A3707DB1284641C3F528FC46215541F6285C2F8B28464152B81EA53B215541AE47E17A612846413D0AD7C32F2155413D0AD7C352284641295C8FD23E2155411F85EBF1562846410AD7A33043215541C3F528FC4F284641B81E85FB4F215541EC51B8FE402846411F85EB7177215541000000403A284641F6285CBF8921554185EB51582F28464148E17AB49821554185EB51D817284641E17A144EAB215541AE47E1FA0C28464133333393B0215541B81E85EBFE2746410AD7A3F0B4215541295C8FA2DE2746415C8FC285BE215541E17A144EB4274641AE47E1AAC6215541B81E85AB9D274641A4703DFACA215541EC51B89E76274641713D0A87CF2155417B14AE07542746410AD7A360D4215541C3F5289C1C274641C3F528ACCF21554114AE47A10B27464114AE4731CD215541AE47E1FAFA264641EC51B84EC8215541F6285C0FEA264641000000A0C2215541C3F5283CC62646419A999979B9215541B81E858BB7264641A4703D8AB8215541AE47E1DAA9264641E17A14AEBB215541000000409F264641713D0A47BE215541AE47E19A94264641713D0A17C02155410AD7A3107D2646417B14AE87C1215541EC51B8BE69264641AE47E19AC021554185EB5138592646413D0AD703BF215541F6285CCF41264641D7A3705DBC215541F6285CAF292646411F85EB01B9215541AE47E15A182646411F85EB61B6215541C3F5283C0C26464133333323B8215541C3F528FCFF2546419A9999B9BC215541E17A14CEF625464148E17A84C22155413D0AD7A3F4254641713D0A27CA21554100000040F6254641295C8F12D12155417B14AE67FE25464114AE4711DC215541C3F528BC0426464152B81E45E4215541B81E856B06264641713D0A07EA21554185EB511807264641A4703D9AF4215541295C8F4201264641A4703D2A062255413D0AD723FB2546417B14AEB70E225541666666E6F525464152B81E851922554114AE4761EC2546418FC2F5B821225541666666E6E3254641CDCCCC1C2622554185EB5198D8254641295C8F52272255413D0AD743CE254641B81E85AB292255415C8FC2F5CC254641EC51B8CE30225541 |
|------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|

* Get roads near parcels (using KNN)

#+BEGIN_SRC sql -n :engine postgresql :exports code :cmdline "-A -w -h localhost -d dbgeo1 -U user" :cache no
WITH
parcels AS (
    SELECT
    osm_id, name, way
    FROM planet_osm_polygon
    WHERE
    tags->'leisure'='park'
    AND name LIKE '%Herăstrău%'
    LIMIT 3
), roads AS (
    SELECT
    osm_id, name, way
    FROM planet_osm_line
    WHERE tags->highway = 'motorway'
)
-- do KNN cross-join between parcels and roads
-- to get nearby roads (rn)
SELECT
DISTINCT ON (rn.osm_id)
rn.osm_id, rn.name, p.osm_id, p.name, dr
FROM parcels p
CROSS JOIN LATERAL (
    SELECT
    *,
    -- distance to road
    ST_Distance(p.way,r.way) as dr
    FROM roads r
    ORDER BY p.way <-> r.way
    LIMIT 5
) rn;
#+END_SRC

#+RESULTS:
|    osm_id | name                             |   osm_id | name             |               dr |
|-----------+----------------------------------+----------+------------------+------------------|
| 256097200 | Autostrada A3 București - Brașov | 91797290 | Parcul Herăstrău | 4811.94254256013 |
| 284325578 | Autostrada A3 București - Brașov | 88337012 | Parcul Herăstrău | 4720.09021304696 |
| 284325581 | Autostrada A3 București - Brașov | 91797290 | Parcul Herăstrău | 5646.77391636125 |
| 284325583 | Autostrada A3 București - Brașov | 91797290 | Parcul Herăstrău | 4810.49220818408 |
| 284325584 | Autostrada A3 București - Brașov | 88337000 | Parcul Herăstrău | 5214.54571198697 |

